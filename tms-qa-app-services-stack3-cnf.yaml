AWSTemplateFormatVersion: '2010-09-09'
Description: Application Stack - ECS Task Definitions and Services with AWS Best Practices

Parameters:
  EnvironmentTag:
    Type: String
    Default: qa
    Description: Environment name
  RegionName:
    Type: String
    Default: us-east-1
    Description: AWS Region for resources (e.g., us-east-1, us-west-2)
  ClusterName:
    Type: String
    Default: TMS-qa-app-cluster
    Description: ECS Cluster name
  ImageTag:
    Type: String
    Default: "1.0.0"
    Description: Docker image tag for deployment (use semantic versioning, e.g., 1.0.0)
  FrontendPrivateSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Manually created Frontend Private Subnet IDs
    Default: subnet-089ae8c862b6dbe13,subnet-0b5bdcda2d95513b7
  BackendPrivateSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Manually created Backend Private Subnet IDs
    Default: subnet-0a2f6c5f35a48f45c,subnet-0c32c64e5765f40da
  
  # Resource Configuration Parameters
  TaskCpu:
    Type: Number
    Default: 512
    Description: CPU units for ECS tasks
  TaskMemory:
    Type: Number
    Default: 1024
    Description: Memory (MB) for ECS tasks
  ContainerCpu:
    Type: Number
    Default: 256
    Description: CPU units for containers
  ContainerMemory:
    Type: Number
    Default: 512
    Description: Memory (MB) for containers
  LogRetentionDays:
    Type: Number
    Default: 7
    Description: CloudWatch log retention in days
  
  # Tag Parameters
  Environment:
    Type: String
    Default: QA
    Description: Environment tag value
  Application:
    Type: String
    Default: TMS-QA
    Description: Application tag value
  ApplicationOwner:
    Type: String
    Default: "Charles Link"
    Description: Application owner tag value
  
  # Auto Scaling Parameters
  MinCapacity:
    Type: Number
    Default: 1
    Description: Minimum number of tasks
  MaxCapacity:
    Type: Number
    Default: 10
    Description: Maximum number of tasks
  DesiredCapacity:
    Type: Number
    Default: 1
    Description: Desired number of tasks
  TargetCpuUtilization:
    Type: Number
    Default: 70
    Description: Target CPU utilization percentage
  TargetMemoryUtilization:
    Type: Number
    Default: 80
    Description: Target memory utilization percentage

Mappings:
  ServicePorts:
    frontend:
      port: 80
    drivers:
      port: 8001
    vehicles:
      port: 8002
    alertconfigs:
      port: 8003
    trips:
      port: 8004
    facilities:
      port: 8005
    carrierprofile:
      port: 8006
    usermgt:
      port: 8007



Resources:
  # Task Definitions
  FrontendTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${EnvironmentTag}-frontend-task"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskExecutionRoleArn"
      TaskRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskRoleArn"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      ContainerDefinitions:
        - Name: frontend-container
          Image: !Sub 
            - "${ECRUri}:${ImageTag}"
            - ECRUri: !ImportValue 
                Fn::Sub: "${EnvironmentTag}-FrontendECRUri"
              ImageTag: !Ref ImageTag
          Essential: true
          Cpu: !Ref ContainerCpu
          Memory: !Ref ContainerMemory
          MemoryReservation: !Ref ContainerMemory
          StopTimeout: 120
          PortMappings:
            - ContainerPort: !FindInMap [ServicePorts, frontend, port]
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref FrontendLogGroup
              awslogs-region: !Ref RegionName
              awslogs-stream-prefix: frontend
          HealthCheck:
            Command:
              - CMD-SHELL
              - "curl -f http://localhost:80/docs || exit 1"
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 120
          LinuxParameters:
            InitProcessEnabled: true
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentTag
            - Name: PORT
              Value: !FindInMap [ServicePorts, frontend, port]

  DriversTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${EnvironmentTag}-drivers-task"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskExecutionRoleArn"
      TaskRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskRoleArn"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      ContainerDefinitions:
        - Name: drivers-container
          Image: !Sub 
            - "${ECRUri}:${ImageTag}"
            - ECRUri: !ImportValue 
                Fn::Sub: "${EnvironmentTag}-driversECRUri"
              ImageTag: !Ref ImageTag
          Essential: true
          Cpu: !Ref ContainerCpu
          Memory: !Ref ContainerMemory
          MemoryReservation: !Ref ContainerMemory
          StopTimeout: 120
          PortMappings:
            - ContainerPort: !FindInMap [ServicePorts, drivers, port]
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref DriversLogGroup
              awslogs-region: !Ref RegionName
              awslogs-stream-prefix: drivers
          HealthCheck:
            Command:
              - CMD-SHELL
              - "curl -f http://localhost:8001/docs || exit 1"
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 120
          LinuxParameters:
            InitProcessEnabled: true
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentTag
            - Name: REDIRECT_URI
              Value: https://remove-uat-api.reworldwaste.com/users/
            - Name: FRONTEND_URI
              Value: https://remove-uat.reworldwaste.com/load-board
          Secrets:
            - Name: TMS_SECRETS
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:tms-qa-LDiZ53
            - Name: TMS_TABLES
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:TMS_TABLES-I7obHA

  VehiclesTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${EnvironmentTag}-vehicles-task"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskExecutionRoleArn"
      TaskRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskRoleArn"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      ContainerDefinitions:
        - Name: vehicles-container
          Image: !Sub 
            - "${ECRUri}:${ImageTag}"
            - ECRUri: !ImportValue 
                Fn::Sub: "${EnvironmentTag}-vehiclesECRUri"
              ImageTag: !Ref ImageTag
          Essential: true
          Cpu: !Ref ContainerCpu
          Memory: !Ref ContainerMemory
          MemoryReservation: !Ref ContainerMemory
          StopTimeout: 120
          PortMappings:
            - ContainerPort: !FindInMap [ServicePorts, vehicles, port]
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref VehiclesLogGroup
              awslogs-region: !Ref RegionName
              awslogs-stream-prefix: vehicles
          HealthCheck:
            Command:
              - CMD-SHELL
              - "curl -f http://localhost:8002/docs || exit 1"
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 120
          LinuxParameters:
            InitProcessEnabled: true
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentTag
            - Name: REDIRECT_URI
              Value: https://remove-uat-api.reworldwaste.com/users/
            - Name: FRONTEND_URI
              Value: https://remove-uat.reworldwaste.com/load-board
          Secrets:
            - Name: TMS_SECRETS
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:tms-qa-LDiZ53
            - Name: TMS_TABLES
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:TMS_TABLES-I7obHA

  TripsTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${EnvironmentTag}-trips-task"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskExecutionRoleArn"
      TaskRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskRoleArn"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      ContainerDefinitions:
        - Name: trips-container
          Image: !Sub 
            - "${ECRUri}:${ImageTag}"
            - ECRUri: !ImportValue 
                Fn::Sub: "${EnvironmentTag}-tripsECRUri"
              ImageTag: !Ref ImageTag
          Essential: true
          Cpu: !Ref ContainerCpu
          Memory: !Ref ContainerMemory
          MemoryReservation: !Ref ContainerMemory
          StopTimeout: 120
          PortMappings:
            - ContainerPort: !FindInMap [ServicePorts, trips, port]
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref TripsLogGroup
              awslogs-region: !Ref RegionName
              awslogs-stream-prefix: trips
          HealthCheck:
            Command:
              - CMD-SHELL
              - "curl -f http://localhost:8004/docs || exit 1"
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 120
          LinuxParameters:
            InitProcessEnabled: true
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentTag
            - Name: REDIRECT_URI
              Value: https://remove-uat-api.reworldwaste.com/users/
            - Name: FRONTEND_URI
              Value: https://remove-uat.reworldwaste.com/load-board
          Secrets:
            - Name: TMS_SECRETS
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:tms-qa-LDiZ53
            - Name: TMS_TABLES
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:TMS_TABLES-I7obHA

  AlertConfigsTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${EnvironmentTag}-alertconfigs-task"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskExecutionRoleArn"
      TaskRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskRoleArn"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      ContainerDefinitions:
        - Name: alertconfigs-container
          Image: !Sub 
            - "${ECRUri}:${ImageTag}"
            - ECRUri: !ImportValue 
                Fn::Sub: "${EnvironmentTag}-alertconfigsECRUri"
              ImageTag: !Ref ImageTag
          Essential: true
          Cpu: !Ref ContainerCpu
          Memory: !Ref ContainerMemory
          MemoryReservation: !Ref ContainerMemory
          StopTimeout: 120
          PortMappings:
            - ContainerPort: !FindInMap [ServicePorts, alertconfigs, port]
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref AlertConfigsLogGroup
              awslogs-region: !Ref RegionName
              awslogs-stream-prefix: alertconfigs
          HealthCheck:
            Command:
              - CMD-SHELL
              - "curl -f http://localhost:8003/docs || exit 1"
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 120
          LinuxParameters:
            InitProcessEnabled: true
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentTag
            - Name: REDIRECT_URI
              Value: https://remove-uat-api.reworldwaste.com/users/
            - Name: FRONTEND_URI
              Value: https://remove-uat.reworldwaste.com/load-board
          Secrets:
            - Name: TMS_SECRETS
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:tms-qa-LDiZ53
            - Name: TMS_TABLES
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:TMS_TABLES-I7obHA

  CarrierProfileTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${EnvironmentTag}-carrierprofile-task"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskExecutionRoleArn"
      TaskRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskRoleArn"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      ContainerDefinitions:
        - Name: carrierprofile-container
          Image: !Sub 
            - "${ECRUri}:${ImageTag}"
            - ECRUri: !ImportValue 
                Fn::Sub: "${EnvironmentTag}-carrierProfileECRUri"
              ImageTag: !Ref ImageTag
          Essential: true
          Cpu: !Ref ContainerCpu
          Memory: !Ref ContainerMemory
          MemoryReservation: !Ref ContainerMemory
          StopTimeout: 120
          PortMappings:
            - ContainerPort: !FindInMap [ServicePorts, carrierprofile, port]
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref CarrierProfileLogGroup
              awslogs-region: !Ref RegionName
              awslogs-stream-prefix: carrierprofile
          HealthCheck:
            Command:
              - CMD-SHELL
              - "curl -f http://localhost:8006/docs || exit 1"
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 120
          LinuxParameters:
            InitProcessEnabled: true
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentTag
            - Name: REDIRECT_URI
              Value: https://remove-uat-api.reworldwaste.com/users/
            - Name: FRONTEND_URI
              Value: https://remove-uat.reworldwaste.com/load-board
          Secrets:
            - Name: TMS_SECRETS
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:tms-qa-LDiZ53
            - Name: TMS_TABLES
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:TMS_TABLES-I7obHA

  FacilitiesTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${EnvironmentTag}-facilities-task"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskExecutionRoleArn"
      TaskRoleArn: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-TaskRoleArn"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      ContainerDefinitions:
        - Name: facilities-container
          Image: !Sub 
            - "${ECRUri}:${ImageTag}"
            - ECRUri: !ImportValue 
                Fn::Sub: "${EnvironmentTag}-facilitiesECRUri"
              ImageTag: !Ref ImageTag
          Essential: true
          Cpu: !Ref ContainerCpu
          Memory: !Ref ContainerMemory
          MemoryReservation: !Ref ContainerMemory
          StopTimeout: 120
          PortMappings:
            - ContainerPort: !FindInMap [ServicePorts, facilities, port]
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref FacilitiesLogGroup
              awslogs-region: !Ref RegionName
              awslogs-stream-prefix: facilities
          HealthCheck:
            Command:
              - CMD-SHELL
              - "curl -f http://localhost:8005/docs || exit 1"
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 120
          LinuxParameters:
            InitProcessEnabled: true
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentTag
            - Name: REDIRECT_URI
              Value: https://remove-uat-api.reworldwaste.com/users/
            - Name: FRONTEND_URI
              Value: "https://remove-uat.reworldwaste.com/load-board"
          Secrets:
            - Name: TMS_SECRETS
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:tms-qa-LDiZ53
            - Name: TMS_TABLES
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:TMS_TABLES-I7obHA

  UserMgtTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${EnvironmentTag}-usermgt-task"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !ImportValue
        Fn::Sub: "${EnvironmentTag}-TaskExecutionRoleArn"
      TaskRoleArn: !ImportValue
        Fn::Sub: "${EnvironmentTag}-TaskRoleArn"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      ContainerDefinitions:
        - Name: usermgt-container
          Image: !Sub
            - "${ECRUri}:${ImageTag}"
            - ECRUri: !ImportValue
                Fn::Sub: "${EnvironmentTag}-userMgtECRUri"
              ImageTag: !Ref ImageTag
          Essential: true
          Cpu: !Ref ContainerCpu
          Memory: !Ref ContainerMemory
          MemoryReservation: !Ref ContainerMemory
          StopTimeout: 120
          PortMappings:
            - ContainerPort: !FindInMap [ServicePorts, usermgt, port]
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref UserMgtLogGroup
              awslogs-region: !Ref RegionName
              awslogs-stream-prefix: usermgt
          HealthCheck:
            Command:
              - CMD-SHELL
              - "curl -f http://localhost:8007/docs || exit 1"
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 120
          LinuxParameters:
            InitProcessEnabled: true
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentTag
            - Name: env
              Value: uat
            - Name: REDIRECT_URI
              Value: https://remove-uat-api.reworldwaste.com/users/
            - Name: FRONTEND_URI
              Value: https://remove-uat.reworldwaste.com/load-board
          Secrets:
            - Name: TMS_SECRETS
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:tms-qa-LDiZ53
            - Name: TMS_TABLES
              ValueFrom: arn:aws:secretsmanager:us-east-1:846376693876:secret:TMS_TABLES-I7obHA
  FrontendLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${EnvironmentTag}-frontend"
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  DriversLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${EnvironmentTag}-drivers"
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  VehiclesLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${EnvironmentTag}-vehicles"
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  TripsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${EnvironmentTag}-trips"
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  AlertConfigsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${EnvironmentTag}-alertconfigs"
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  CarrierProfileLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${EnvironmentTag}-carrierprofile"
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FacilitiesLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${EnvironmentTag}-facilities"
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  UserMgtLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${EnvironmentTag}-usermgt"
      RetentionInDays: !Ref LogRetentionDays
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  # ECS Services
  FrontendService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub "${EnvironmentTag}-frontend-service"
      Cluster: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-ClusterArn"
      TaskDefinition: !Ref FrontendTaskDefinition
      DesiredCount: !Ref DesiredCapacity
      LaunchType: FARGATE
      EnableExecuteCommand: true
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue 
                Fn::Sub: "${EnvironmentTag}-FargateSecurityGroupId"
          Subnets: !Ref FrontendPrivateSubnetIds
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: frontend-container
          ContainerPort: !FindInMap [ServicePorts, frontend, port]
          TargetGroupArn: !ImportValue 
            Fn::Sub: "${EnvironmentTag}-FrontendTargetGroupArn"

  DriversService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub "${EnvironmentTag}-drivers-service"
      Cluster: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-ClusterArn"
      TaskDefinition: !Ref DriversTaskDefinition
      DesiredCount: !Ref DesiredCapacity
      LaunchType: FARGATE
      EnableExecuteCommand: true
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue 
                Fn::Sub: "${EnvironmentTag}-FargateSecurityGroupId"
          Subnets: !Ref BackendPrivateSubnetIds
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: drivers-container
          ContainerPort: !FindInMap [ServicePorts, drivers, port]
          TargetGroupArn: !ImportValue 
            Fn::Sub: "${EnvironmentTag}-driversTargetGroupArn"

  VehiclesService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub "${EnvironmentTag}-vehicles-service"
      Cluster: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-ClusterArn"
      TaskDefinition: !Ref VehiclesTaskDefinition
      DesiredCount: !Ref DesiredCapacity
      LaunchType: FARGATE
      EnableExecuteCommand: true
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue 
                Fn::Sub: "${EnvironmentTag}-FargateSecurityGroupId"
          Subnets: !Ref BackendPrivateSubnetIds
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: vehicles-container
          ContainerPort: !FindInMap [ServicePorts, vehicles, port]
          TargetGroupArn: !ImportValue 
            Fn::Sub: "${EnvironmentTag}-vehiclesTargetGroupArn"

  TripsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub "${EnvironmentTag}-trips-service"
      Cluster: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-ClusterArn"
      TaskDefinition: !Ref TripsTaskDefinition
      DesiredCount: !Ref DesiredCapacity
      LaunchType: FARGATE
      EnableExecuteCommand: true
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue 
                Fn::Sub: "${EnvironmentTag}-FargateSecurityGroupId"
          Subnets: !Ref BackendPrivateSubnetIds
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: trips-container
          ContainerPort: !FindInMap [ServicePorts, trips, port]
          TargetGroupArn: !ImportValue 
            Fn::Sub: "${EnvironmentTag}-tripsTargetGroupArn"

  AlertConfigsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub "${EnvironmentTag}-alertconfigs-service"
      Cluster: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-ClusterArn"
      TaskDefinition: !Ref AlertConfigsTaskDefinition
      DesiredCount: !Ref DesiredCapacity
      LaunchType: FARGATE
      EnableExecuteCommand: true
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue 
                Fn::Sub: "${EnvironmentTag}-FargateSecurityGroupId"
          Subnets: !Ref BackendPrivateSubnetIds
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: alertconfigs-container
          ContainerPort: !FindInMap [ServicePorts, alertconfigs, port]
          TargetGroupArn: !ImportValue 
            Fn::Sub: "${EnvironmentTag}-alertconfigsTargetGroupArn"

  CarrierProfileService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub "${EnvironmentTag}-carrierprofile-service"
      Cluster: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-ClusterArn"
      TaskDefinition: !Ref CarrierProfileTaskDefinition
      DesiredCount: !Ref DesiredCapacity
      LaunchType: FARGATE
      EnableExecuteCommand: true
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue 
                Fn::Sub: "${EnvironmentTag}-FargateSecurityGroupId"
          Subnets: !Ref BackendPrivateSubnetIds
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: carrierprofile-container
          ContainerPort: !FindInMap [ServicePorts, carrierprofile, port]
          TargetGroupArn: !ImportValue 
            Fn::Sub: "${EnvironmentTag}-carrierProfileTargetGroupArn"

  FacilitiesService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub "${EnvironmentTag}-facilities-service"
      Cluster: !ImportValue 
        Fn::Sub: "${EnvironmentTag}-ClusterArn"
      TaskDefinition: !Ref FacilitiesTaskDefinition
      DesiredCount: !Ref DesiredCapacity
      LaunchType: FARGATE
      EnableExecuteCommand: true
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue 
                Fn::Sub: "${EnvironmentTag}-FargateSecurityGroupId"
          Subnets: !Ref BackendPrivateSubnetIds
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: facilities-container
          ContainerPort: !FindInMap [ServicePorts, facilities, port]
          TargetGroupArn: !ImportValue 
            Fn::Sub: "${EnvironmentTag}-facilitiesTargetGroupArn"

  UserMgtService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub "${EnvironmentTag}-usermgt-service"
      Cluster: !ImportValue
        Fn::Sub: "${EnvironmentTag}-ClusterArn"
      TaskDefinition: !Ref UserMgtTaskDefinition
      DesiredCount: !Ref DesiredCapacity
      LaunchType: FARGATE
      EnableExecuteCommand: true
      EnableECSManagedTags: true
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref Application
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
                Fn::Sub: "${EnvironmentTag}-FargateSecurityGroupId"
          Subnets: !Ref BackendPrivateSubnetIds
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: usermgt-container
          ContainerPort: !FindInMap [ServicePorts, usermgt, port]
          TargetGroupArn: !ImportValue
            Fn::Sub: "${EnvironmentTag}-userMgtTargetGroupArn"

  # Auto Scaling Configuration for Frontend
  FrontendScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    DependsOn: FrontendService
    Properties:
      MaxCapacity: !Ref MaxCapacity
      MinCapacity: !Ref MinCapacity
      ResourceId: !Sub "service/${ClusterName}/${EnvironmentTag}-frontend-service"
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  FrontendCPUScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-frontend-cpu-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref FrontendScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetCpuUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  FrontendMemoryScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-frontend-memory-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref FrontendScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetMemoryUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  # Auto Scaling Configuration for Drivers
  DriversScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    DependsOn: DriversService
    Properties:
      MaxCapacity: !Ref MaxCapacity
      MinCapacity: !Ref MinCapacity
      ResourceId: !Sub "service/${ClusterName}/${EnvironmentTag}-drivers-service"
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  DriversCPUScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-drivers-cpu-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref DriversScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetCpuUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  DriversMemoryScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-drivers-memory-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref DriversScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetMemoryUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  # Auto Scaling Configuration for Vehicles
  VehiclesScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    DependsOn: VehiclesService
    Properties:
      MaxCapacity: !Ref MaxCapacity
      MinCapacity: !Ref MinCapacity
      ResourceId: !Sub "service/${ClusterName}/${EnvironmentTag}-vehicles-service"
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  VehiclesCPUScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-vehicles-cpu-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref VehiclesScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetCpuUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  VehiclesMemoryScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-vehicles-memory-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref VehiclesScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetMemoryUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  # Auto Scaling Configuration for Trips
  TripsScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    DependsOn: TripsService
    Properties:
      MaxCapacity: !Ref MaxCapacity
      MinCapacity: !Ref MinCapacity
      ResourceId: !Sub "service/${ClusterName}/${EnvironmentTag}-trips-service"
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  TripsCPUScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-trips-cpu-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref TripsScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetCpuUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  TripsMemoryScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-trips-memory-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref TripsScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetMemoryUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  # Auto Scaling Configuration for AlertConfigs
  AlertConfigsScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    DependsOn: AlertConfigsService
    Properties:
      MaxCapacity: !Ref MaxCapacity
      MinCapacity: !Ref MinCapacity
      ResourceId: !Sub "service/${ClusterName}/${EnvironmentTag}-alertconfigs-service"
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  AlertConfigsCPUScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-alertconfigs-cpu-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref AlertConfigsScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetCpuUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  AlertConfigsMemoryScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-alertconfigs-memory-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref AlertConfigsScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetMemoryUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  # Auto Scaling Configuration for CarrierProfile
  CarrierProfileScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    DependsOn: CarrierProfileService
    Properties:
      MaxCapacity: !Ref MaxCapacity
      MinCapacity: !Ref MinCapacity
      ResourceId: !Sub "service/${ClusterName}/${EnvironmentTag}-carrierprofile-service"
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  CarrierProfileCPUScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-carrierprofile-cpu-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref CarrierProfileScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetCpuUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  CarrierProfileMemoryScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-carrierprofile-memory-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref CarrierProfileScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetMemoryUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  # Auto Scaling Configuration for Facilities
  FacilitiesScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    DependsOn: FacilitiesService
    Properties:
      MaxCapacity: !Ref MaxCapacity
      MinCapacity: !Ref MinCapacity
      ResourceId: !Sub "service/${ClusterName}/${EnvironmentTag}-facilities-service"
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  FacilitiesCPUScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-facilities-cpu-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref FacilitiesScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetCpuUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  FacilitiesMemoryScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-facilities-memory-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref FacilitiesScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetMemoryUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  # Auto Scaling Configuration for UserMgt
  UserMgtScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    DependsOn: UserMgtService
    Properties:
      MaxCapacity: !Ref MaxCapacity
      MinCapacity: !Ref MinCapacity
      ResourceId: !Sub "service/${ClusterName}/${EnvironmentTag}-usermgt-service"
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  UserMgtCPUScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-usermgt-cpu-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref UserMgtScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetCpuUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

  UserMgtMemoryScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${EnvironmentTag}-usermgt-memory-scaling"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref UserMgtScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref TargetMemoryUtilization
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization
        ScaleOutCooldown: 60
        ScaleInCooldown: 300

Outputs:
  StackVersion:
    Description: Stack with all AWS best practices implemented
    Value: "v1.0"
  TotalServices:
    Description: Number of ECS services deployed
    Value: "8"
  AutoScalingEnabled:
    Description: Auto-scaling configured for all services
    Value: "true"
  DeploymentCircuitBreakerEnabled:
    Description: Deployment circuit breaker enabled for safe rollouts
    Value: "true"
