AWSTemplateFormatVersion: '2010-09-09'
Description: Infrastructure Stack - ECS Cluster, ALBs, ECR, Security Groups

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Manually created VPC ID
    Default: vpc-0d6db502f4ce2b847
  FrontendPrivateSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Manually created Frontend Private Subnet IDs 
    Default: "subnet-089ae8c862b6dbe13,subnet-0b5bdcda2d95513b7"
  BackendPrivateSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Manually created Backend Private Subnet IDs 
    Default: "subnet-0a2f6c5f35a48f45c,subnet-0c32c64e5765f40da"
  EnvironmentTag:
    Type: String
    Default: qa
    Description: Environment name
  SSLCertificateArn:
    Type: String
    Description: SSL Certificate ARN from AWS Certificate Manager 
  ApplicationProxyCIDR:
    Type: String
    Description: CIDR block for Application Proxy connector
    Default: "10.0.0.0/16"
  ReworldNetworkCIDR:
    Type: String
    Description: CIDR block for internal Reworld Network
    Default: "192.168.0.0/16"
  WorkspaceCIDR:
    Type: String
    Description: CIDR block for workspace access
    Default: "172.28.88.0/21"
  
  
  # Application Configuration
  Application:
    Type: String
    Default: TMS
    Description: Application name for resource naming
  Environment:
    Type: String
    Default: QA
    Description: Environment tag value
  ApplicationOwner:
    Type: String
    Default: "Charles Link"
    Description: Application owner tag value
  
  # Existing IAM Roles
  ExistingTaskExecutionRoleArn:
    Type: String
    Description: ARN of existing ECS Task Execution Role
    Default: "arn:aws:iam::846376693876:role/ecsTaskExecutionRole"
  ExistingTaskRoleArn:
    Type: String
    Description: ARN of existing ECS Task Role
    Default: "arn:aws:iam::846376693876:role/ecsTaskRole"
  
  # ALB Configuration
  ALBScheme:
    Type: String
    Default: internal
    AllowedValues: [internal, internet-facing]
    Description: ALB scheme 
  IdleTimeoutSeconds:
    Type: Number
    Default: 300
    Description: ALB idle timeout in seconds
  
  # Health Check Configuration
  HealthCheckPath:
    Type: String
    Default: /health
    Description: Health check path for target groups
  HealthCheckIntervalSeconds:
    Type: Number
    Default: 30
    Description: Health check interval in seconds
  HealthCheckTimeoutSeconds:
    Type: Number
    Default: 5
    Description: Health check timeout in seconds
  HealthyThresholdCount:
    Type: Number
    Default: 2
    Description: Healthy threshold count
  UnhealthyThresholdCount:
    Type: Number
    Default: 3
    Description: Unhealthy threshold count

  # Existing S3 Bucket
  ExistingS3Bucket:
    Type: String
    Default: "tms-qa-app-s3"
    Description: Existing S3 bucket name for ALB access logs

Resources:
  # S3 Bucket Policy for ALB Access Logs (using existing bucket)
  ALBAccessLogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    DeletionPolicy: Retain
    Properties:
      Bucket: !Ref ExistingS3Bucket
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              AWS: "arn:aws:iam::127311923021:root"
            Action: s3:PutObject
            Resource: !Sub "arn:aws:s3:::${ExistingS3Bucket}/alb-access-logs/*"
          - Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub "arn:aws:s3:::${ExistingS3Bucket}/alb-access-logs/*"
          - Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !Sub "arn:aws:s3:::${ExistingS3Bucket}"

  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "${Application}-${EnvironmentTag}-app-cluster"
      CapacityProviders:
        - FARGATE
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FrontendALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Frontend ALB Security Group
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref ApplicationProxyCIDR
          Description: HTTP from Application Proxy
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref ApplicationProxyCIDR
          Description: HTTPS from Application Proxy
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref ReworldNetworkCIDR
          Description: HTTP from Reworld Network
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref ReworldNetworkCIDR
          Description: HTTPS from Reworld Network
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref WorkspaceCIDR
          Description: HTTP from Workspace
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref WorkspaceCIDR
          Description: HTTP from Workspace
        
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  BackendALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Backend ALB Security Group
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref FrontendALBSecurityGroup
          Description: HTTP from Frontend ALB only
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref FrontendALBSecurityGroup
          Description: HTTPS from Frontend ALB only
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref ApplicationProxyCIDR
          Description: HTTP from Application Proxy
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref ApplicationProxyCIDR
          Description: HTTPS from Application Proxy
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref ReworldNetworkCIDR
          Description: HTTP from Reworld Network
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref ReworldNetworkCIDR
          Description: HTTPS from Reworld Network
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref WorkspaceCIDR
          Description: HTTP from Workspace
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref WorkspaceCIDR
          Description: HTTPS from Workspace     
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FargateSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Fargate Security Group
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref FrontendALBSecurityGroup
          Description: HTTP from Frontend ALB
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref FrontendALBSecurityGroup
          Description: HTTPS from Frontend ALB
        - IpProtocol: tcp
          FromPort: 8001
          ToPort: 8007
          SourceSecurityGroupId: !Ref BackendALBSecurityGroup
          Description: Backend services from Backend ALB
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FrontendECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/frontend-app"
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  driversECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/drivers-service"
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  vehiclesECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/vehicles-service"
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  tripsECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/trips-service"
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  alertconfigsECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/alertconfigs-service"
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  carrierProfileECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/carrierprofile-service"
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  facilitiesECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/facilities-service"
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  userMgtECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/user-mgt-service"
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FrontendALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${Application}-${EnvironmentTag}-fe-alb"
      Scheme: !Ref ALBScheme
      Type: application
      Subnets: !Ref FrontendPrivateSubnetIds
      LoadBalancerAttributes:
        - Key: idle_timeout.timeout_seconds
          Value: !Ref IdleTimeoutSeconds
        - Key: access_logs.s3.enabled
          Value: "true"
        - Key: access_logs.s3.bucket
          Value: !Ref ExistingS3Bucket
        - Key: access_logs.s3.prefix
          Value: "alb-access-logs/frontend-alb"
      SecurityGroups:
        - !Ref FrontendALBSecurityGroup
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  BackendALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${Application}-${EnvironmentTag}-back-alb"
      Scheme: !Ref ALBScheme
      Type: application
      Subnets: !Ref BackendPrivateSubnetIds
      LoadBalancerAttributes:
        - Key: idle_timeout.timeout_seconds
          Value: !Ref IdleTimeoutSeconds
        - Key: access_logs.s3.enabled
          Value: "true"
        - Key: access_logs.s3.bucket
          Value: !Ref ExistingS3Bucket
        - Key: access_logs.s3.prefix
          Value: "alb-access-logs/backend-alb"
      SecurityGroups:
        - !Ref BackendALBSecurityGroup
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FrontendTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-frontend-tg"
      Port: 80
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: !Ref HealthCheckPath
      HealthCheckIntervalSeconds: !Ref HealthCheckIntervalSeconds
      HealthCheckTimeoutSeconds: !Ref HealthCheckTimeoutSeconds
      HealthyThresholdCount: !Ref HealthyThresholdCount
      UnhealthyThresholdCount: !Ref UnhealthyThresholdCount
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  driversTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-drivers-tg"
      Port: 8001
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  vehiclesTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-vehicles-tg"
      Port: 8002
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  tripsTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-trips-tg"
      Port: 8004
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  alertconfigsTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-alertconfigs-tg"
      Port: 8003
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  carrierProfileTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-carrierProfile-tg"
      Port: 8006
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  facilitiesTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-facilities-tg"
      Port: 8005
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  userMgtTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-user-mgt-tg"
      Port: 8007
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner
          
  FrontendHTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: 443
            StatusCode: HTTP_301
      LoadBalancerArn: !Ref FrontendALB
      Port: 80
      Protocol: HTTP

  FrontendHTTPSListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref FrontendTargetGroup
      LoadBalancerArn: !Ref FrontendALB
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref SSLCertificateArn

  BackendListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: 443
            StatusCode: HTTP_301
      LoadBalancerArn: !Ref BackendALB
      Port: 80
      Protocol: HTTP

  BackendHTTPSListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: 404 
            ContentType: application/json
            MessageBody: '{"response":"Specify the endpoints"}'
      LoadBalancerArn: !Ref BackendALB
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref SSLCertificateArn

  DriverHTTPSRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendHTTPSListener 
      Priority: 110
      Conditions:
        - Field: path-pattern
          Values:
            - /drivers/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref driversTargetGroup

  vehicleHTTPSRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendHTTPSListener
      Priority: 210 
      Conditions:
        - Field: path-pattern
          Values:
            - /vehicles/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref vehiclesTargetGroup

  TripsHTTPSRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendHTTPSListener
      Priority: 310 
      Conditions:
        - Field: path-pattern
          Values:
            - /trips/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref tripsTargetGroup

  alertconfigsHTTPSRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendHTTPSListener
      Priority: 410 
      Conditions:
        - Field: path-pattern
          Values:
            - /alertconfigs/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref alertconfigsTargetGroup

  carrierProfileHTTPSRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendHTTPSListener
      Priority: 510 
      Conditions:
        - Field: path-pattern
          Values:
            - /carrierProfile/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref carrierProfileTargetGroup

  facilitiesHTTPSRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendHTTPSListener
      Priority: 610 
      Conditions:
        - Field: path-pattern
          Values:
            - /facilities/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref facilitiesTargetGroup

  userMgtHTTPSRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendHTTPSListener
      Priority: 710 
      Conditions:
        - Field: path-pattern
          Values:
            - /users/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref userMgtTargetGroup

Outputs:
  ClusterArn:
    Value: !GetAtt ECSCluster.Arn
    Export:
      Name: !Sub "${EnvironmentTag}-ClusterArn"

  ClusterName:
    Value: !Ref ECSCluster
    Export:
      Name: !Sub "${EnvironmentTag}-ClusterName"

  TaskExecutionRoleArn:
    Value: !GetAtt ECSTaskExecutionRole.Arn
    Export:
      Name: !Sub "${EnvironmentTag}-TaskExecutionRoleArn"

  TaskRoleArn:
    Value: !GetAtt ECSTaskRole.Arn
    Export:
      Name: !Sub "${EnvironmentTag}-TaskRoleArn"

  FargateSecurityGroupId:
    Value: !Ref FargateSecurityGroup
    Export:
      Name: !Sub "${EnvironmentTag}-FargateSecurityGroupId"

  BackendListenerArn:
    Value: !Ref BackendListener
    Export:
      Name: !Sub "${EnvironmentTag}-BackendListenerArn"

  BackendHTTPSListenerArn:
    Value: !Ref BackendHTTPSListener
    Export:
      Name: !Sub "${EnvironmentTag}-BackendHTTPSListenerArn"

  BackendALBDNSName:
    Value: !GetAtt BackendALB.DNSName
    Export:
      Name: !Sub "${EnvironmentTag}-BackendALBDNSName"
    Description: Backend ALB DNS name for domain configuration

  FrontendHTTPSListenerArn:
    Value: !Ref FrontendHTTPSListener
    Export:
      Name: !Sub "${EnvironmentTag}-FrontendHTTPSListenerArn"

  FrontendALBDNSName:
    Value: !GetAtt FrontendALB.DNSName
    Export:
      Name: !Sub "${EnvironmentTag}-FrontendALBDNSName"
    Description: Frontend ALB DNS name for domain configuration

  ALBAccessLogsBucket:
    Value: !Ref ExistingS3Bucket
    Export:
      Name: !Sub "${EnvironmentTag}-ALBAccessLogsBucket"
    Description: S3 bucket for ALB access logs

  FrontendTargetGroupArn:
    Value: !Ref FrontendTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-FrontendTargetGroupArn"

  driversTargetGroupArn:
    Value: !Ref driversTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-driversTargetGroupArn"

  vehiclesTargetGroupArn:
    Value: !Ref vehiclesTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-vehiclesTargetGroupArn"

  tripsTargetGroupArn:
    Value: !Ref tripsTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-tripsTargetGroupArn"

  alertconfigsTargetGroupArn:
    Value: !Ref alertconfigsTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-alertconfigsTargetGroupArn"

  carrierProfileTargetGroupArn:
    Value: !Ref carrierProfileTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-carrierProfileTargetGroupArn"

  facilitiesTargetGroupArn:
    Value: !Ref facilitiesTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-facilitiesTargetGroupArn"

  userMgtTargetGroupArn:
    Value: !Ref userMgtTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-userMgtTargetGroupArn"

  FrontendECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${FrontendECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-FrontendECRUri"

  driversECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${driversECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-driversECRUri"

  vehiclesECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${vehiclesECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-vehiclesECRUri"

  tripsECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${tripsECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-tripsECRUri"

  alertconfigsECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${alertconfigsECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-alertconfigsECRUri"

  carrierProfileECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${carrierProfileECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-carrierProfileECRUri"

  facilitiesECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${facilitiesECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-facilitiesECRUri"

  userMgtECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${userMgtECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-userMgtECRUri"
