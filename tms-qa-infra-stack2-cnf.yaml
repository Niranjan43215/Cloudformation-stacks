AWSTemplateFormatVersion: '2010-09-09'
Description: Infrastructure Stack - ECS Cluster, ALBs, ECR, Security Groups

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Manually created VPC ID
    Default: 
  FrontendPrivateSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Manually created Frontend Private Subnet IDs 
    Default: "subnet-089ae8c862b6dbe13,subnet-0b5bdcda2d95513b7"
  BackendPrivateSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Manually created Backend Private Subnet IDs 
    Default: "subnet-0a2f6c5f35a48f45c,subnet-0c32c64e5765f40da"
  TEnvironmentag:
    Type: String
    Default: qa
    Description: Environment name
  SSLCertificateArn:
    Type: String
    Description: SSL Certificate ARN from AWS Certificate Manager (imported 3rd party cert)
  ApplicationProxyCIDR:
    Type: String
    Description: CIDR block for Application Proxy connector
    Default: "10.0.0.0/16"
  ReworldNetworkCIDR:
    Type: String
    Description: CIDR block for internal Reworld Network
    Default: "192.168.0.0/16"
  
  # Application Configuration
  Application:
    Type: String
    Default: TMS
    Description: Application name for resource naming
  Environment:
    Type: String
    Default: QA
    Description: Environment tag value
  ApplicationOwner:
    Type: String
    Default: "Charles Link"
    Description: Application owner tag value
  
  # Existing IAM Roles
  ExistingTaskExecutionRoleArn:
    Type: String
    Description: ARN of existing ECS Task Execution Role
    Default: "arn:aws:iam::846376693876:role/ecsTaskExecutionRole"
  ExistingTaskRoleArn:
    Type: String
    Description: ARN of existing ECS Task Role
    Default: "arn:aws:iam::846376693876:role/ecsTaskRole"
  
  # ALB Configuration
  ALBScheme:
    Type: String
    Default: internal
    AllowedValues: [internal, internet-facing]
    Description: ALB scheme (internal or internet-facing)
  IdleTimeoutSeconds:
    Type: Number
    Default: 60
    Description: ALB idle timeout in seconds
  
  # Health Check Configuration
  HealthCheckPath:
    Type: String
    Default: /health
    Description: Health check path for target groups
  HealthCheckIntervalSeconds:
    Type: Number
    Default: 30
    Description: Health check interval in seconds
  HealthCheckTimeoutSeconds:
    Type: Number
    Default: 5
    Description: Health check timeout in seconds
  HealthyThresholdCount:
    Type: Number
    Default: 2
    Description: Healthy threshold count
  UnhealthyThresholdCount:
    Type: Number
    Default: 3
    Description: Unhealthy threshold count

Mappings:
  ServicePorts:
    drivers:
      port: 8001
    vehicles:
      port: 8002
    alertconfigs:
      port: 8003
    trips:
      port: 8004
    facilities:
      port: 8005
    carrierprofile:
      port: 8006

Resources:
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "${Application}-${EnvironmentTag}-app-cluster"
      CapacityProviders:
        - FARGATE
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FrontendALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Frontend ALB Security Group
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref ApplicationProxyCIDR
          Description: HTTP from Application Proxy
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref ApplicationProxyCIDR
          Description: HTTPS from Application Proxy
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref ReworldNetworkCIDR
          Description: HTTP from Reworld Network
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref ReworldNetworkCIDR
          Description: HTTPS from Reworld Network
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  BackendALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Backend ALB Security Group
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref FrontendALBSecurityGroup
          Description: HTTP from Frontend ALB only
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FargateSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Fargate Security Group
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref FrontendALBSecurityGroup
          Description: HTTP from Frontend ALB
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref FrontendALBSecurityGroup
          Description: HTTPS from Frontend ALB
        - IpProtocol: tcp
          FromPort: 8001
          ToPort: 8006
          SourceSecurityGroupId: !Ref BackendALBSecurityGroup
          Description: Backend services from Backend ALB
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FrontendECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/frontend-app"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  driversECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/drivers-service"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  vehiclesECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/vehicles-service"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  tripsECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/trips-service"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  alertconfigsECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/alertconfigs-service"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  carrierProfileECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/carrierprofile-service"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  facilitiesECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${EnvironmentTag}/facilities-service"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FrontendALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${Application}-${EnvironmentTag}-fe-alb"
      Scheme: !Ref ALBScheme
      Type: application
      Subnets: !Ref FrontendPrivateSubnetIds
      SecurityGroups:
        - !Ref FrontendALBSecurityGroup
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  BackendALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${Application}-${EnvironmentTag}-back-alb"
      Scheme: !Ref ALBScheme
      Type: application
      Subnets: !Ref BackendPrivateSubnetIds
      SecurityGroups:
        - !Ref BackendALBSecurityGroup
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FrontendTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-frontend-tg"
      Port: 80
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: !Ref HealthCheckPath
      HealthCheckIntervalSeconds: !Ref HealthCheckIntervalSeconds
      HealthCheckTimeoutSeconds: !Ref HealthCheckTimeoutSeconds
      HealthyThresholdCount: !Ref HealthyThresholdCount
      UnhealthyThresholdCount: !Ref UnhealthyThresholdCount
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  driversTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-drivers-tg"
      Port: 8001
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  vehiclesTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-vehicles-tg"
      Port: 8002
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  tripsTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-trips-tg"
      Port: 8004
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  alertconfigsTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-alertconfigs-tg"
      Port: 8003
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  carrierProfileTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-carrierProfile-tg"
      Port: 8006
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  facilitiesTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentTag}-facilities-tg"
      Port: 8005
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Sub "${Application}-${Environment}"
        - Key: "Application Owner"
          Value: !Ref ApplicationOwner

  FrontendHTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: 443
            StatusCode: HTTP_301
      LoadBalancerArn: !Ref FrontendALB
      Port: 80
      Protocol: HTTP

  FrontendHTTPSListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref FrontendTargetGroup
      LoadBalancerArn: !Ref FrontendALB
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref SSLCertificateArn

  BackendListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: 404 
            ContentType: application/json
            MessageBody: '{"response":"Specify the endpoints"}'
      LoadBalancerArn: !Ref BackendALB
      Port: 80
      Protocol: HTTP

  DriverRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendListener 
      Priority: 100
      Conditions:
        - Field: path-pattern
          Values:
            - /drivers/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref driversTargetGroup

  vehicleRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendListener
      Priority: 200 
      Conditions:
        - Field: path-pattern
          Values:
            - /vehicles/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref vehiclesTargetGroup

  TripsRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendListener
      Priority: 300 
      Conditions:
        - Field: path-pattern
          Values:
            - /trips/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref tripsTargetGroup

  alertconfigsRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendListener
      Priority: 400 
      Conditions:
        - Field: path-pattern
          Values:
            - /alertconfigs/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref alertconfigsTargetGroup

  carrierProfileRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendListener
      Priority: 500 
      Conditions:
        - Field: path-pattern
          Values:
            - /carrierProfile/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref carrierProfileTargetGroup

  facilitiesRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref BackendListener
      Priority: 600 
      Conditions:
        - Field: path-pattern
          Values:
            - /facilities/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref facilitiesTargetGroup

Outputs:
  ClusterArn:
    Value: !GetAtt ECSCluster.Arn
    Export:
      Name: !Sub "${EnvironmentTag}-ClusterArn"

  ClusterName:
    Value: !Ref ECSCluster
    Export:
      Name: !Sub "${EnvironmentTag}-ClusterName"

  TaskExecutionRoleArn:
    Value: !GetAtt ECSTaskExecutionRole.Arn
    Export:
      Name: !Sub "${EnvironmentTag}-TaskExecutionRoleArn"

  TaskRoleArn:
    Value: !GetAtt ECSTaskRole.Arn
    Export:
      Name: !Sub "${EnvironmentTag}-TaskRoleArn"

  FargateSecurityGroupId:
    Value: !Ref FargateSecurityGroup
    Export:
      Name: !Sub "${EnvironmentTag}-FargateSecurityGroupId"

  BackendListenerArn:
    Value: !Ref BackendListener
    Export:
      Name: !Sub "${EnvironmentTag}-BackendListenerArn"

  FrontendTargetGroupArn:
    Value: !Ref FrontendTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-FrontendTargetGroupArn"

  driversTargetGroupArn:
    Value: !Ref driversTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-driversTargetGroupArn"

  vehiclesTargetGroupArn:
    Value: !Ref vehiclesTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-vehiclesTargetGroupArn"

  tripsTargetGroupArn:
    Value: !Ref tripsTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-tripsTargetGroupArn"

  alertconfigsTargetGroupArn:
    Value: !Ref alertconfigsTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-alertconfigsTargetGroupArn"

  carrierProfileTargetGroupArn:
    Value: !Ref carrierProfileTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-carrierProfileTargetGroupArn"

  facilitiesTargetGroupArn:
    Value: !Ref facilitiesTargetGroup
    Export:
      Name: !Sub "${EnvironmentTag}-facilitiesTargetGroupArn"

  FrontendECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${FrontendECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-FrontendECRUri"

  driversECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${driversECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-driversECRUri"

  vehiclesECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${vehiclesECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-vehiclesECRUri"

  tripsECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${tripsECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-tripsECRUri"

  alertconfigsECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${alertconfigsECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-alertconfigsECRUri"

  carrierProfileECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${carrierProfileECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-carrierProfileECRUri"

  facilitiesECRUri:
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${facilitiesECR}"
    Export:
      Name: !Sub "${EnvironmentTag}-facilitiesECRUri"